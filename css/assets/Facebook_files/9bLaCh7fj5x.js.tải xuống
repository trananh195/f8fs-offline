;/*FB_PKG_DELIM*/

__d("MAWQPLLogger",["QPLUserFlow","Random"],(function(a,b,c,d,e,f,g){"use strict";function a(a){return{addQPLAnnotations:function(b,d){c("QPLUserFlow").addAnnotations(a,d,{instanceKey:b})},markQPLCancel:function(b){c("QPLUserFlow").endCancel(a,{instanceKey:b})},markQPLFailure:function(b,d){var e;c("QPLUserFlow").endFailure(a,(e=d==null?void 0:d.name)!=null?e:"fail",{error:d,instanceKey:b})},markQPLFailureWithMsg:function(b,d){c("QPLUserFlow").endFailure(a,d,{instanceKey:b})},markQPLPoint:function(b,d,e){c("QPLUserFlow").addPoint(a,d,{debugInfo:e,instanceKey:b})},markQPLStart:function(){var b=Date.now()+(Math.round(d("Random").random()*1e4)+1e4);c("QPLUserFlow").start(a,{instanceKey:b});return b},markQPLSuccess:function(b){c("QPLUserFlow").endSuccess(a,{instanceKey:b})}}}g["default"]=a}),98);
__d("MAWDataSourceLogger",["I64","MAWQPLLogger","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(){i==null&&(i=c("MAWQPLLogger")(c("qpl")._(25303796,"1974")));return i}function a(){return j().markQPLStart()}function b(a,b,c){j().markQPLPoint(a,"wait_act_thread_start","before fetching messages range from table"),j().addQPLAnnotations(a,{"int":{version:1},string:{direction:b,thread_id:(h||(h=d("I64"))).to_string(c)}})}function e(a,b){j().markQPLFailureWithMsg(a,b)}function f(a){j().markQPLCancel(a)}function k(a){j().markQPLPoint(a,"wait_act_thread_end","before fetching messages range from table"),j().markQPLPoint(a,"load_more_msgs_start","load more messages from MAW DB")}function l(a,b){j().markQPLPoint(a,"load_more_msgs_end","Note: OLD SOLUTION DOES NOT FETCH messages. they are fetched in afterTransaction that we cannot control"),j().addQPLAnnotations(a,{bool:{hasMoreBefore:b}})}function m(a){j().markQPLSuccess(a)}function n(a,b){j().markQPLPoint(a,"issued_range_query","MAWFetchSecureMessages: minMsgSortOrderTsResponse "+b)}function o(a,b){j().markQPLFailure(a,b)}g.logLoadMoreMsgsStart=a;g.logLoadMoreMsgsThreadWaiting=b;g.logLoadMoreMsgsFailure=e;g.logLoadMoreMsgsCancel=f;g.logLoadMoreMsgsThreadReadyFetchMsgs=k;g.logLoadMoreMsgsFetched=l;g.logLoadMoreMsgsSuccess=m;g.logLoadMoreMsgsRangeQuery=n;g.logLoadMoreMsgsRuntimeError=o}),98);
__d("MAWFindLowerEBAndLocalDBIntersection",[],(function(a,b,c,d,e,f){"use strict";function a(a,b){if(b.length===0)return a;var c=Number.MAX_SAFE_INTEGER;for(var d=0;d<b.length;d++){var e=b[d];e.sortOrderMs<c&&(c=e.sortOrderMs)}e=0;while(e<a.length&&c>a[e].sortOrderMs)e++;return a.slice(e)}f.findOldestTsIntersection=a}),66);
__d("MAWIsEBEnabled",["I64","LSEncryptedBackupsBackupTenancy","LSIntEnum","MAWEncryptedBackupUtils","asyncToGeneratorRuntime","gkx"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function a(a){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){if(!c("gkx")("23914"))return!1;a=(yield d("MAWEncryptedBackupUtils").getBackupTenancy(a.tables));return a!=null&&(h||(h=d("I64"))).equal(a,(i||(i=d("LSIntEnum"))).ofNumber(c("LSEncryptedBackupsBackupTenancy").PRODUCTION))});return j.apply(this,arguments)}g.isEbEnabled=a}),98);
__d("MAWPutMessagesToDB",["MAWBridgeDeleteReactionHandler","MAWBridgeMsgsStartCountdownHandler","MAWBridgeNewMediaHandler","MAWBridgeNewMsgHandler","MAWBridgeNewXMAHandler","MAWBridgeReactionUpsertHandler","Promise","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(a,b){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,c){var e=c.expiringCountdown,f=c.medias,g=c.msgs,i=c.reactions;c=c.xmas;yield d("MAWBridgeNewMsgHandler").bulkCall(a,g);yield (h||(h=b("Promise"))).all(f.map(function(b){return d("MAWBridgeNewMediaHandler").call(a,b)}));yield h.all(c.map(function(b){return d("MAWBridgeNewXMAHandler").call(a,b)}));yield d("MAWBridgeMsgsStartCountdownHandler").call(a,{msgs:e});yield h.all(i.map(function(b){return b.type==="delete"?d("MAWBridgeDeleteReactionHandler").call(a,b.reaction):d("MAWBridgeReactionUpsertHandler").call(a,b.reaction)}))});return j.apply(this,arguments)}function a(a,b){return a.runInTransaction(function(a){return i(a,b)},"readwrite","ui")}g.insertMessageResponseToDBInExistingTransaction=i;g.insertMessageResponseIntoDatabase=a}),98);
__d("MAWSecureDataSource",[],(function(a,b,c,d,e,f){"use strict";a=10;f.DEFAULT_NUM_MESSAGES=a}),66);
__d("MAWSecureLocalDBFetch",["I64","MAWBridgeSendAndReceive","MAWDbMsg","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.chatJid,c=a.config,e=a.count,f=a.direction,g=a.offsetMsg;a=a.timestampMs;return babelHelpers["extends"]({},yield d("MAWBridgeSendAndReceive").sendAndReceive("backend","maw_load_msgs",{chatJid:b,config:c,direction:f,includeOriginalMsg:(b=g==null?void 0:g.includeOriginalMsg)!=null?b:!1,msgId:(g==null?void 0:g.messageId)==null?null:d("MAWDbMsg").toMsgId(g.messageId),numMsgs:e,sortOrderMs:a!=null?(h||(h=d("I64"))).to_float(a):null}))});return i.apply(this,arguments)}g["default"]=a}),98);
__d("MAWSecureLocalDBDataSource",["I64","MAWBridgeSendAndReceive","MAWDataSourceLogger","MAWDbMsg","MAWFindLowerEBAndLocalDBIntersection","MAWIsEBEnabled","MAWMiActOnActThreadReady","MAWPutMessagesToDB","MAWSecureDataSource","MAWSecureLocalDBFetch","MWEncryptedBackupsIssueRangeQuery","Promise","ReQL","WAResultOrError","WATagsLogger","asyncToGeneratorRuntime","gkx","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to fetch messages: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["useFetchSecureMessages: threadJid: "," threadId: "," minMsgSortOrderTsResponse ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Fetch more: ",""]);l=function(){return a};return a}var m=c("requireDeferred")("MAWEBFetch").__setRef("MAWSecureLocalDBDataSource"),n=d("WATagsLogger").TAGS(["MAWSecureLocalDBDataSource"]);a=function(){function a(){}var e=a.prototype;e.$1=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,f,g,j,o,p){if(j==="after")return;j;n.LOG(l(),e);d("MAWDataSourceLogger").logLoadMoreMsgsThreadWaiting(p,"before",e);j=(yield d("MAWMiActOnActThreadReady").waitForACTThreadReady(a.tables,e,"MAWFetchMoreMessages"));var q=j.chatId;j=j.chatJid;d("MAWDataSourceLogger").logLoadMoreMsgsThreadReadyFetchMsgs(p);var r=c("MAWSecureLocalDBFetch")({chatJid:j,config:{editMsgHistory:!0,media:!0,reactions:!0,xma:!0},count:o,direction:"before",offsetMsg:{includeOriginalMsg:!1,messageId:g.minMessageId},timestampMs:f}),s;if(c("gkx")("1560")){var t=(yield d("MAWIsEBEnabled").isEbEnabled(a));t=(yield (i||(i=b("Promise"))).all([r,t?m.load().then(function(b){return b({chatId:q,count:o,db:a,direction:"before",timestampMs:f})}):(i||(i=b("Promise"))).resolve(d("WAResultOrError").makeError(d("MWEncryptedBackupsIssueRangeQuery").EB_NOT_ENABLED))]));var u=t[0];t=t[1];s=u;u=t.success?t.value.messages.toReversed():[];s.msgs=d("MAWFindLowerEBAndLocalDBIntersection").findOldestTsIntersection(s.msgs,u)}else s=(yield r),u=[];var v=s.msgs.length>0?s.msgs[s.msgs.length-1].msgId:g.minMessageId;yield a.runInTransaction(function(){var c=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){var c;yield d("MAWPutMessagesToDB").insertMessageResponseToDBInExistingTransaction(b,s);c=(yield (c=b.messages_ranges_v2__generated).get.apply(c,[g.threadKey,g.minTimestampMs,g.minMessageId]));if(c==null)return;var e=s.hasMoreBefore;s.hasMoreBefore===!1&&(yield d("MAWIsEBEnabled").isEbEnabled(a))&&(e=!0);yield b.messages_ranges_v2__generated.upsert([c.threadKey,c.minTimestampMs,c.minMessageId],{hasMoreAfter:!1,hasMoreBefore:e,isLoadingAfter:!1,isLoadingBefore:!1,maxMessageId:c.maxMessageId,maxTimestampMs:c.maxTimestampMs,minMessageId:v,minTimestampMs:(h||(h=d("I64"))).zero,threadKey:g.threadKey})});return function(a){return c.apply(this,arguments)}}(),"readwrite","ui");d("MAWDataSourceLogger").logLoadMoreMsgsFetched(p,s.hasMoreBefore);if(s.hasMoreBefore){d("MAWDataSourceLogger").logLoadMoreMsgsSuccess(p);return}t=(yield d("MAWBridgeSendAndReceive").sendAndReceive("backend","getMaybeNextNonAdminMsgSortOrderMs",{chatJid:j,mayBeAdminMsgId:d("MAWDbMsg").toMsgId(g.minMessageId)}));d("WATagsLogger").TAGS(["labyrinth_web","useFetchSecureMessages"]).LOG(k(),j,q,t.minMsgTimestampMs);d("MAWDataSourceLogger").logLoadMoreMsgsRangeQuery(p,t.minMsgTimestampMs);r=(yield m.load());u=(yield r({chatId:q,count:o,db:a,direction:"before",timestampMs:(h||(h=d("I64"))).of_float(t.minMsgTimestampMs)}));u.success&&u.value.hasMoreBefore===!1&&(yield a.runInTransaction(function(){var c=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){var c=g.minTimestampMs,f=(yield d("ReQL").firstAsync(d("ReQL").fromTableDescending(a.tables.messages_ranges_v2__generated).getKeyRange(e).bounds({lte:[c]}).filter(function(a){var b=a.maxTimestampMs;a=a.minTimestampMs;return(h||(h=d("I64"))).ge(c,a)&&(h||(h=d("I64"))).le(c,b)})));if(f==null)return;yield b.messages_ranges_v2__generated.upsert([f.threadKey,f.minTimestampMs,f.minMessageId],babelHelpers["extends"]({},f,{hasMoreBefore:!1,isLoadingBefore:!1}))});return function(a){return c.apply(this,arguments)}}(),"readwrite","ui"));d("MAWDataSourceLogger").logLoadMoreMsgsSuccess(p)});function e(b,c,d,e,f,g,h){return a.apply(this,arguments)}return e}();e.requestMessages=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f,g,h,i,j){b=(yield c("MAWSecureLocalDBFetch")({chatJid:e,config:j,count:(a=i)!=null?a:d("MAWSecureDataSource").DEFAULT_NUM_MESSAGES,direction:h,offsetMsg:g==null?null:{includeOriginalMsg:!1,messageId:g},timestampMs:f}));e=b.msgs.map(function(a){return{externalId:a.externalId,msgType:a.type_,sortOrderMs:a.sortOrderMs}});return{hasMoreAfter:b.hasMoreAfter,hasMoreBefore:b.hasMoreBefore,msgs:e}});function e(b,c,d,e,f,g,h,i){return a.apply(this,arguments)}return e}();e.fetchSecureMessagesProtocol=function(a,b,c,e,f,g){g===void 0&&(g=d("MAWSecureDataSource").DEFAULT_NUM_MESSAGES);var h=d("MAWDataSourceLogger").logLoadMoreMsgsStart();return this.$1(a,b,c,e,f,g,h)["catch"](function(a){n.ERROR(j(),a),d("MAWDataSourceLogger").logLoadMoreMsgsRuntimeError(h,a)})};return a}();g["default"]=a}),98);
__d("MWPFetchMessagesThreadLocks",["FBLogger","I64"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b){var e=(h||(h=d("I64"))).to_string(b);return{lock:{after:function(){var b=f();b.after===!0&&c("FBLogger")("messenger_web_product").mustfix("Locking threadLockStatus twice");b.after=!0;a.set(e,b)},before:function(){var b=f();b.before===!0&&c("FBLogger")("messenger_web_product").mustfix("Locking threadLockStatus twice");b.before=!0;a.set(e,b)}},release:{after:function(){var b=f();b.after=!1;a.set(e,b)},before:function(){var b=f();b.before=!1;a.set(e,b)}},state:f()};function f(){var b=a.get(e);b==null&&(b={after:!1,before:!1},a.set(e,b));return b}}g.localThreadStatus=a}),98);
__d("MWPFetchMessagesPageV2",["FBLogger","LSFactory","LSIntEnum","LSIssueMessagesRangeQueryStoredProcedure","LSMailboxMessagesRangeQueryDirection","LSMessagingThreadTypeUtil","MWPFetchMessagesThreadLocks","asyncToGeneratorRuntime","nullthrows","qex"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b,c,d,e,f,g,h){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f,g,h,i,j){var k,m;k=(yield (k=a.tables.messages_ranges_v2__generated).get.apply(k,f));if(k==null)return;m=h&&(yield (m=a.tables.messages_ranges_v2__generated).get.apply(m,h));if(m==null&&h!=null)return;h=d("LSMessagingThreadTypeUtil").isArmadilloSecure(g);g=i!=null?d("LSMessagingThreadTypeUtil").isArmadilloSecure(i):!1;if(e==="before")if(k.hasMoreBefore)if(h)return l(a,b,e,k,j);else return n(a,f,k.threadKey,e);else if(m!=null)if(g)return l(a,b,e,m,j);else return n(a,[m.threadKey,m.minTimestampMs,m.minMessageId],m.threadKey,e);else return;else{e;if(k.hasMoreAfter)if(h)throw c("FBLogger")("messenger_web_product").mustfix("Not possible to fetch more after for secure messages");else return n(a,f,k.threadKey,e);else if(m!=null){g=d("LSMessagingThreadTypeUtil").isArmadilloSecure(c("nullthrows")(i));if(g)throw c("FBLogger")("messenger_web_product").mustfix("Not possible to fetch more after for secure messages");else return n(a,[m.threadKey,m.minTimestampMs,m.minMessageId],m.threadKey,e)}else return}});return i.apply(this,arguments)}var j=new Map(),k=new Map();function l(a,b,c,d,e){return m.apply(this,arguments)}function m(){m=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f,g){if(c("qex")._("1215")!==!0){var h=d("MWPFetchMessagesThreadLocks").localThreadStatus(j,f.threadKey);if(h.state[e])return;try{h.lock[e]();var i=(yield a.tables.messages.index("messageId").get(f.minMessageId));return yield g.fetchSecureMessagesProtocol(a,f.threadKey,i==null?void 0:i.primarySortKey,f,e,b)}finally{h.release[e]()}}});return m.apply(this,arguments)}function n(a,b,c,d){return o.apply(this,arguments)}function o(){o=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,f,g){f=d("MWPFetchMessagesThreadLocks").localThreadStatus(k,f);if(f.state[g])return;try{f.lock[g]();return yield a.runInTransaction(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b;b=(yield (b=a.messages_ranges_v2__generated).get.apply(b,e));if(!b)return;if(b.isLoadingBefore&&g==="before")return;if(b.isLoadingAfter&&g==="after")return;return c("LSIssueMessagesRangeQueryStoredProcedure")(c("LSFactory")(a),{direction:(h||(h=d("LSIntEnum"))).ofNumber(g==="before"?c("LSMailboxMessagesRangeQueryDirection").BEFORE:c("LSMailboxMessagesRangeQueryDirection").AFTER),referenceTimestampMs:b.minTimestampMs,threadKey:b.threadKey})});return function(b){return a.apply(this,arguments)}}(),"readwrite","ui")}finally{f.release[g]()}});return o.apply(this,arguments)}g["default"]=a}),98);
__d("MAWPreloadSecureMessages",["I64","LSIntEnum","MAWSecureLocalDBDataSource","MWPFetchMessagesPageV2","Promise","ReQL","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k=new(c("MAWSecureLocalDBDataSource"))();function a(a,b,c,d){return l.apply(this,arguments)}function l(){l=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,f,g){var l=(yield d("ReQL").firstAsync(d("ReQL").fromTableDescending(a.tables.messages_ranges_v2__generated).getKeyRange(e)));e=l!=null?[e,l==null?void 0:l.minTimestampMs,l==null?void 0:l.minMessageId]:null;l=g!=null?yield d("ReQL").firstAsync(d("ReQL").fromTableDescending(a.tables.messages_ranges_v2__generated).getKeyRange(g)):null;g=l!=null?[l==null?void 0:l.threadKey,l==null?void 0:l.minTimestampMs,l==null?void 0:l.minMessageId]:null;l=(i||(i=d("I64"))).equal(f,(j||(j=d("LSIntEnum"))).ofNumber(15))?(j||(j=d("LSIntEnum"))).ofNumber(1):(j||(j=d("LSIntEnum"))).ofNumber(2);return e!=null?c("MWPFetchMessagesPageV2")(a,15,"before",e,f,g,l,k):(h||(h=b("Promise"))).resolve()});return l.apply(this,arguments)}g.preloadSecureMessages=a}),98);